#!/usr/bin/env bash

# This script serves as the SWIG build step of the
# [**Python Buildpack**](https://github.com/heroku/heroku-buildpack-python)
# compiler.
#
# A [buildpack](http://devcenter.heroku.com/articles/buildpacks) is an
# adapter between a Python application and Heroku's runtime.
#
# This script is invoked by [`bin/compile`](/).

# The location of the pre-compiled cryptography binary.
VENDORED_SWIG="https://s3.amazonaws.com/guybowden/swig.tar.gz"

PKG_CONFIG_PATH="/app/.heroku/vendor/lib/pkgconfig:$PKG_CONFIG_PATH"

# Syntax sugar.
source $BIN_DIR/utils

# see the ENV
echo "Current ENV follows ..."
env
echo "..."

bpwatch start swig_install

# If M2Crypto exists within requirements, use vendored SWIG.
# Instead of pip-grep we are using regular grep,  
# since our M2Crypto is sourced from a git repo sitting in GitHub.
if (grep M2Crypto requirements.txt  &> /dev/null) then

	if [ -d ".heroku/vendor/bin/swig" ]; then
		export LIBSWIG=$(pwd)/.heroku/vendor/share/swig/2.0.5
	else
		puts-step "Noticed SWIG. Bootstrapping SWIG."
		mkdir -p .heroku/vendor

		echo "Downloading SWIG from $VENDORED_SWIG" | indent
		# Download SWIG
		curl -O $VENDORED_SWIG >/dev/null 2>&1

		# Extract SWIG into target vendor directory.
		echo "Extracting into target vendor directory." | indent
		tar zxvf swig.tar.gz --strip-components 1 -C .heroku/vendor &> /dev/null

# 		mv swig $CACHE_DIR/swig
		# No need to move the built SWIG to CACHE_DIR, since the compile script does that
		
		rm swig.tar.gz
		echo "SWIG installed." | indent

	fi
  
	export SWIG=$(pwd)/.heroku/vendor/bin/swig

# 	echo "Updating path ..." | indent  
#   	PATH="$PATH:$BUILD_DIR/.heroku/vendor/bin"
#   	export PATH
#   	
#   	echo "Performing set-env on PATH ..." | indent
#   	set-env PATH="$PATH:$BUILD_DIR/.heroku/vendor/bin"

  	echo "PATH:" | indent
  	echo "$PATH" | indent
  	
  	echo "Setting SWIG_LIB environment variable ..." | indent
  	export SWIG_LIB=$BUILD_DIR/.heroku/vendor/share/swig/2.0.5
fi

# see the ENV
echo "Current ENV follows ..."
env
echo "..."

bpwatch stop swig_install
