#!/usr/bin/env bash

# This script serves as the SWIG build step of the
# [**Python Buildpack**](https://github.com/heroku/heroku-buildpack-python)
# compiler.
#
# A [buildpack](http://devcenter.heroku.com/articles/buildpacks) is an
# adapter between a Python application and Heroku's runtime.
#
# This script is invoked by [`bin/compile`](/).

# SWIG variables and source location.
SWIG_VER="3.0.10"
SWIG_BASE="swig-$SWIG_VER"
SWIG_EXT=".tar.gz"
SWIG_FILE=$SWIG_BASE$SWIG_EXT
VENDORED_SWIG="http://prdownloads.sourceforge.net/swig/$SWIG_FILE"

PKG_CONFIG_PATH="/app/.heroku/vendor/lib/pkgconfig:$PKG_CONFIG_PATH"

CURRENT_DIR=$(pwd)
VENDOR_DIR=".heroku/vendor"

# Syntax sugar.
source $BIN_DIR/utils

bpwatch start swig_install

echo "ENV follows:" | indent
env
echo "============" | indent

# If M2Crypto exists within requirements, use vendored SWIG.
# Instead of pip-grep we are using regular grep,
# since our M2Crypto is sourced from a git repo sitting in GitHub.
if (grep M2Crypto requirements.txt  &> /dev/null) then

	if [ ! -f ".heroku/vendor/bin/swig" ]; then
		puts-step "Noticed SWIG. Bootstrapping SWIG."
		mkdir -p $VENDOR_DIR

		echo "Downloading SWIG source from $VENDORED_SWIG" | indent
		# Download SWIG
		curl -o /tmp/$SWIG_FILE -L $VENDORED_SWIG >/dev/null 2>&1

		# Extract SWIG into target vendor directory.
		echo "Extracting into temporary directory." | indent
		tar zxvf /tmp/$SWIG_FILE -C /tmp/ &> /dev/null

		# Build SWIG in place
		echo "Building SWIG in place." | indent
		cd /tmp/$SWIG_BASE
		./configure --prefix=/app/$VENDOR_DIR
		make
		make install

		echo "Revert back to previous directory: $CURRENT_DIR" | indent
		cd $CURRENT_DIR

		# Cleanup after build
		echo "Cleanup build files." | indent
		rm -rf /tmp/$SWIG_BASE*

		# Confirm install
		SWIG_INSTALLED=$($BUILD_DIR/$VENDOR_DIR/bin/swig -version | sed -n '2p')
		echo "SWIG installed as: $SWIG_INSTALLED" | indent

	else
		export LIBSWIG=$(pwd)/.heroku/vendor/share/swig/$SWIG_VER

	fi

	echo "Setting SWIG_LIB environment variable ..." | indent
	export SWIG=$(pwd)/.heroku/vendor/bin/swig
	export SWIG_LIB=$BUILD_DIR/$VENDOR_DIR/share/swig/$SWIG_VER

fi

bpwatch stop swig_install
